@model IEnumerable<ShowTemplateViewModel>

@{
    ViewBag.Title = "Index";
    var currentUser = JsonSerializer.Deserialize<UserSessionModel>(Context.Session.GetString("UserObject")!);

}

    <!-- BEGIN MAIN CONTENT -->
        <div id="main-content">
            <div class="page-title"> <i class="icon-custom-left"></i>
                <h3 class="text-center"><strong>@Localizer["Show Template"]</strong></h3>
            </div>
            <br>
            <br>
            @if(currentUser.UserPermissions.Contains("showtemplate.create")
             ){
                <a style="float: left;" asp-action="Create" asp-controller="ShowTemplate" class="btn btn-primary" role="button">
                    @Localizer["addnewhead"]
                    <i class="fa fa-plus"></i></a>
            }
            <br>
            <br>
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-12 col-sm-12 col-xs-12 table-responsive">
                                    <div id="Print">
                                @if (TempData["TemplateErrors"] != null)
                                {
                                    var errors = TempData["TemplateErrors"] as List<string>;
                                            @if(errors is not null){
                                    <div class="alert alert-danger">
                                        <ul>
                                            @foreach (var error in errors)
                                            {
                                                <li>@error</li>
                                            }
                                        </ul>
                                    </div>
                                            }
                                }
                                        <table id="Datatemplate" class="table table-striped table-hover table-condensed">
                                        <thead class="no-bd">
                                            <tr>
                                                <th>
                                                </th>
                                                <th><strong>@Localizer["ID"]</strong>
                                                </th>
                                                <th><strong>@Localizer["name"]</strong>
                                                </th>
                                                <th><strong>@Localizer["customer"]</strong>
                                                </th>
                                                <th><strong>@Localizer["username"]</strong>
                                                </th>
                                                <th><strong>@Localizer["Col X Row"]</strong>
                                                </th>
                                                <th><strong>@Localizer["cdate"]</strong>
                                                </th>
                                                <th><strong>@Localizer["udate"]</strong>
                                                </th>
                                                @if(currentUser.UserPermissions.Contains("showtemplate.update")
                                                 ){
                                                    <th><strong>@Localizer["state"]</strong>
                                                    </th>
                                                }
                                                @if(currentUser.UserPermissions.Contains("showtemplate.update")
                                                || currentUser.UserPermissions.Contains("showtemplate.delete")
                                                 ){
                                                <th><strong>@Localizer["actions"]</strong>
                                                </th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody class="no-bd-y">
                                                @foreach(var ShowTemplate in Model){
                                                    <tr>
                                                        <td >
                                                        </td>
                                                        <td class="text-center">
                                                            @ShowTemplate.TempId
                                                        </td>
                                                        <td class="text-center">
                                                            @if(@ShowTemplate.TempNameAr == "null"){
                                                                @ShowTemplate.TempNameEng     
                                                            }else{
                                                                @ShowTemplate.TempNameAr                                       
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @ShowTemplate.TempCustomerName
                                                        </td>
                                                        <td class="text-center">
                                                            @ShowTemplate.TempByUserName
                                                        </td>
                                                        <td class="text-center">
                                                            <div>@ShowTemplate.TempRowNo * @ShowTemplate.TempColNo</div>
                                                        </td>
                                                        <td class="text-center">
                                                            @ShowTemplate.TempCdate?.ToString("dd/MM/yyyy")
                                                        </td>
                                                        <td class="text-center">
                                                            @ShowTemplate.TempUdate?.ToString("dd/MM/yyyy")
                                                        </td>
                                                        @if(currentUser.UserPermissions.Contains("showtemplate.update")
                                                         ){
                                                                <td class="text-center">
                                                                     @if(@ShowTemplate.TempIsactive){
                                                                        <button  onclick='ToggleOnAndOff(event,"@ShowTemplate.TempId")' class="btn btn-sm btn-success" controll="ShowTemplate" >
                                                                            @Localizer["on"]
                                                                            <i class="bi bi-power" style="pointer-events: none;"></i>
                                                                        </button>
                                                                    }else{ 
                                                                        <button onclick='ToggleOnAndOff(event,"@ShowTemplate.TempId")' class="btn btn-sm btn-danger" controll="ShowTemplate" >
                                                                            @Localizer["off"]
                                                                            <i class="bi bi-power" style="pointer-events: none;"></i>

                                                                        </button>
                                                                    }
                                                                </td>
                                                        }
                                                        @if(currentUser.UserPermissions.Contains("showtemplate.update") || currentUser.UserPermissions.Contains("showtemplate.delete")){
                                                            <td style="float:left;">
                                                                @if(currentUser.UserPermissions.Contains("showtemplate.update")){
                                                                    <a asp-action="Edit" asp-controller="ShowTemplate" asp-route-id="@ShowTemplate.TempId" class="btn btn-primary" type="button">@Localizer["edit"]</a>
                                                                }
                                                                @if(currentUser.UserPermissions.Contains("showtemplate.delete")){
                                                                    <button type="button" id="DeleteButton" onclick="MoveTheIdToModal(@ShowTemplate.TempId)" class="btn btn-danger" data-toggle="modal" data-target="#exampleModal">
                                                                        @Localizer["delete"]
                                                                    </button>
                                                                }
                                                            </td>
                                                        }
                                                    </tr>
                                                }
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center" id="exampleModalLabel">@Localizer["confirmdelete"]</h5>
 
      </div>
      <div class="modal-body text-center">
        @Localizer["deletemodalbody"]
      </div>
      <div class="modal-footer">
        <form id="DeleteForm" method="get" asp-action="Delete" asp-controller="ShowTemplate" asp-route-id="">
            <button type="button" class="btn btn-secondary" data-dismiss="modal"> @Localizer["close"]</button>
            <button type="submit" class="btn btn-danger"> @Localizer["delete"]</button>
        </form>
        </div>
    </div>
  </div>
</div>

@section Scripts{
    <script>
         function MoveTheIdToModal(CustId){
            var elem = document.getElementById("DeleteForm")
            var elemValue = elem.getAttribute('action').split('/');
            var newhref = '/' + elemValue[1] + '/' + elemValue[2] + '/' + CustId;
            elem.setAttribute("action", newhref); 
        }


$(document).ready( function () {
    var table = $("#Datatemplate").DataTable({
        "pageLength": 50,
        dom: "Bfrtip",
        "buttons": ['print' ,
                'excelHtml5',
            {
        extend: "pdfHtml5",
        orientation: 'portrait',
        pageSize: 'A4',
        exportOptions: {
            orthogonal: "myExport",
            columns: [6 , 5 ,4, 3, 2, 1, 0],
            },
        customize: function(doc) {
            doc.defaultStyle.font = "arial";
        },
            }
        ],
        columnDefs: [
        {
            targets: 0,
            className: 'dt-control',
            orderable: false,
            data: null,
            defaultContent: '',
            searchable: false
            
        },
        {
            targets: 1,
            orderable: false,
            searchable: false,
            visible: false
        },
        {
            targets: "hiddenCols",
            visible: false,
            render: function(data, type, row) {
            if (type = 'myExport') {
                return data.split(' ').reverse().join(' ');
            }
                return data;
            }
        }
        ]
    });
    

     $('#Datatemplate tbody').on('click', 'td.dt-control', function () {

        var tr = $(this).closest('tr');
        var row = table.row(tr);
        var id = row.data()[1];

        if (row.child.isShown()) {
            row.child.hide();
        }
        else {
            GetNestedData(id).then((res) => {
                row.child(res).show();
            });
        }
    });


    async function GetNestedData(id) {
    var NestedData = "<div class=\"row\">";
    NestedData += "<div class=\"form-group col\">";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">State</Label></div>";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">Zone Height %</Label></div>";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">Zone Width %</Label></div>";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">Zone Name</Label></div>";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">Zone Id</Label></div>";
    NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\"><Label class=\"form-control text-center\" tabindex=\"6\">#</Label></div>";
    NestedData += "</div></div>";
    NestedData += "<form role=\"form\" action=\"/ShowTemplate/UpdateTemplatesDetails\" method=\"post\">";

    $.ajax({
        url: '/ShowTemplate/GetTemplatesDetails/' + id,
        type: 'GET',
        cache: false,
        async: false,
        success: function (data) {
            var i = 0;
            data.forEach(x => {
                console.log(x);
                NestedData += "<div class=\"row\">";
                NestedData += "<div class=\"form-group col\">";

                // Checkbox ·Õ«·… «·«ﬂ ›
                NestedData += `<div class=\"col-xs-4 col-sm-2 col-md-2   \">`;
                NestedData += `<input type="checkbox" id="TempDetails_${i}__IsActive " name="TempDetails[${i}].IsActive" class="form-control text-center" tabindex="6" ${x.tempIsactive ? 'checked' : ''} onclick="toggleState(this, ${i})"/>`;
                            NestedData += `<label for="TempDetails_${i}__IsActive" class="form-control text-center">${x.tempIsactive == 1 ? '‰‘ÿ' : '€Ì— ‰‘ÿ'}</label>`;
                    NestedData += `<input type="hidden" id="TempDetails_${i}__IsActiveHidden" name="TempDetails[${i}].IsActiveHidden" value="${x.tempIsactive ? 1 : 0}"/>`; // Hidden input
                    NestedData += `</div>`;

                // Õﬁ· «— ›«⁄ «·„‰ÿﬁ…
                NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\">";
                NestedData += `<input type="number" id="TempDetails_${i}__TempZoneHeight" name="TempDetails[${i}].TempZoneHeight" class="form-control text-center" value="${x.tempZoneHeight}" tabindex="6"/>`;
                NestedData += "</div>";

                // Õﬁ· ⁄—÷ «·„‰ÿﬁ…
                NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\">";
                NestedData += `<input type="number" id="TempDetails_${i}__TempZoneWidth" name="TempDetails[${i}].TempZoneWidth" class="form-control text-center" value="${x.tempZoneWidth}" tabindex="6"/>`;
                NestedData += "</div>";

                // «”„ «·„‰ÿﬁ…
                NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\">";
                NestedData += `<input class=\"form-control text-center\" tabindex="6" value="Zone ${i + 1}" disabled />`;
                NestedData += "</div>";

                // ﬂÊœ «·„‰ÿﬁ…
                NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\">";
                NestedData += `<input id="TempDetails_${i}__TempZoneCode" name="TempDetails[${i}].TempZoneCode" class="form-control text-center" tabindex="6" value="${x.tempZoneCode}" disabled />`;
                NestedData += "</div>";

                // —ﬁ„ «·„‰ÿﬁ…
                NestedData += "<div class=\"col-xs-4 col-sm-2 col-md-2\">";
                NestedData += `<input class=\"form-control text-center\" tabindex="6" value="${i + 1}" disabled/>`;
                NestedData += "</div>";

                //  ›«’Ì· «·„‰ÿﬁ… („Œ›Ì)
                NestedData += `<div style="display: none;" class="invisible"><input value="${x.tempDetail}" id="TempDetails_${i}__TempDetail" name="TempDetails[${i}].TempDetail" class="d-none" type="text" /></div>`;
                NestedData += "</div></div>";
                i++;
            });
        }
    })
    NestedData += "<button type=\"submit\" class=\"btn btn-success\" style=\"float:left;\">Update</button>";
    NestedData += "</form>";
    return NestedData;
}

function toggleState(checkbox, index) {
    //  Õﬁﬁ „‰ Õ«·… checkbox Ê €ÌÌ— «·ﬁÌ„… «·„Œ›Ì…
    const isActive = checkbox.checked;
    const hiddenInput = document.getElementById(`TempDetails_${index}__IsActiveHidden`);
    
    if (hiddenInput) {
        hiddenInput.value = isActive ? 1 : 0; //  ÕœÌÀ «·ﬁÌ„… «·„Œ›Ì…
    }
}
});

pdfMake.fonts = {arial: {normal: 'arial.ttf',bold: 'arial.ttf',italics: 'arial.ttf',bolditalics: 'arial.ttf'}};


</script>
}


